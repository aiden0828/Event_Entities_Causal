{"tokens": ["In", "November", "8", ",", "2016", "Microsoft", "released", "a", "security", "update", "for", "Windows", "Authentication", "Methods", "(", "MS16", "-", "137", ")", "which", "included", "3", "CVEs", ":", "Talking", "specifically", "about", "CVE", "-2016-7237", ",", "this", "fix", "was", "applied", "to", "\"", "lsasrv.dll", "\"", ",", "which", "affected", "the", "LSASS", "service", ".", "The", "vulnerability", "affected", "all", "Windows", "versions", ",", "either", "32", "or", "64", "bits", ",", "and", "was", "reported", "and", "later", "described", "in", "more", "detail", "by", "Laurent", "Gaffi\u00e9", "(", "@PythonResponder", ")", "the", "same", "day", "that", "the", "fix", "was", "published", ".", "He", "also", "published", "proof", "-", "of", "-", "concept", "(", "PoC", ")", "code", "triggering", "the", "vulnerability", ".", "When", "the", "LSASS", "service", "crashes", ",", "the", "target", "is", "automatically", "restarted", "after", "60", "seconds", ",", "which", "is", "not", "very", "nice", "when", "it", "'s", "a", "production", "server", ".", "As", "this", "allocation", "is", "close", "to", "4", "GB", ",", "this", "will", "probably", "fail.If", "the", "allocation", "fails", ",", "one", "of", "the", "necessary", "conditions", "to", "reproduce", "the", "NULL", "-", "Pointer", "dereference", "will", "be", "reached", ".", "There", "was", "a", "misunderstanding", "here", "about", "the", "vulnerability", ",", "because", "according", "to", "the", "PoC", "released", "by", "Laurent", "Gaffi\u00e9", ",", "the", "problem", "WAS", "N'T", "in", "the", "structure", "pointer", ",", "but", "rather", "in", "one", "field", "of", "the", "CRITICAL_SECTION", "object", "pointed", "by", "this", "structure", ",", "which", "is", "NULL", "when", "the", "huge", "allocation", "fails", "!", "To", "be", "clear", ",", "the", "check", "of", "the", "NULL", "pointer", "should", "probably", "have", "been", "here", ":", "Although", "the", "public", "PoC", "does", "n't", "trigger", "the", "vulnerability", "in", "Windows", "8.1", "or", "Windows", "10", ",", "the", "researcher", "and", "Microsoft", "declared", "these", "Windows", "versions", "as", "vulnerable", ".", "As", "I", "said", "before", ",", "the", "\"", "NegGetExpectedBufferLength", "\"", "function", "reads", "the", "evil", "size", "from", "the", "SMB", "packet", ".", "Now", ",", "this", "function", "has", "to", "return", "the", "0x90312", "value", "(", "SEC_I_CONTINUE_NEEDED", ")", "to", "produce", "the", "fail", "in", "the", "huge", "allocation", ".", "Unfortunately", ",", "in", "the", "latest", "Windows", "versions", ",", "an", "extra", "check", "was", "added", "in", "this", "function", "which", "compares", "the", "evil", "size", "against", "0xffff", "(", "64KB", ")", ".", "If", "the", "evil", "size", "is", "greater", ",", "this", "function", "wo", "n't", "return", "the", "0x90312", "value", ",", "but", "rather", "this", "will", "return", "the", "0xC00000BB", "value", "(", "STATUS_NOT_SUPPORTED", ")", ",", "which", "wo", "n't", "produce", "any", "allocation", "fail", "resulting", "in", "the", "vulnerability", "not", "being", "triggered", ".", "On", "the", "other", "hand", ",", "if", "we", "use", "the", "evil", "size", "with", "a", "value", "less", "or", "equal", "than", "0xffff", "(", "64KB", ")", ",", "the", "allocation", "wo", "n't", "fail", "and", "again", ",", "the", "vulnerability", "wo", "n't", "be", "triggered", ".", "So", ",", "why", "are", "Windows", "8.1", "and", "Windows", "10", "vulnerable", "?", "Although", "the", "bug", "is", "triggered", "when", "a", "memory", "allocation", "fails", ",", "that", "does", "n't", "mean", "that", "the", "allocation", "has", "to", "be", "giant", ",", "but", "rather", "that", "the", "LSASS", "service", "does", "n't", "have", "enough", "available", "memory", "to", "allocate", ".", "I", "had", "been", "able", "to", "confirm", "that", "this", "vulnerability", "can", "be", "triggered", "in", "Windows", "7", "and", "2008", "R2", "by", "establishing", "several", "SMB", "connections", "and", "sending", "evil", "sizes", "with", "values", "like", "0x1000000", "(", "16", "MB", ")", ".", "The", "problem", "is", "that", "in", "the", "case", "of", "the", "latest", "Windows", "versions", ",", "it", "'s", "not", "possible", "to", "use", "this", "kind", "of", "sizes", ",", "because", "as", "I", "said", "before", ",", "the", "limit", "is", "64KB", ".", "So", ",", "the", "only", "way", "to", "trigger", "this", "vulnerability", "should", "be", "by", "producing", "a", "memory", "exhaustion", "in", "the", "LSASS", "service", ".", "It", "may", "be", "possible", "to", "do", "so", "by", "finding", "a", "controllable", "malloc", "in", "the", "LSASS", "authentication", "process", ",", "creating", "multiple", "connections", "and", "producing", "a", "memory", "exhaustion", "until", "the", "\"", "LsapAllocateLsaHeap", "\"", "function", "fails", ".", "Maybe", ",", "this", "memory", "exhaustion", "condition", "could", "be", "easily", "reached", "in", "local", "scenarios", ".", "I", "realized", "that", "the", "fix", "was", "n't", "working", "when", "I", "tried", "to", "understand", "why", "the", "public", "PoC", "was", "n't", "working", "against", "Windows", "10", ".", "It", "'s", "surprising", "to", "see", "that", "nobody", "else", "noticed", "that", "\u2013", "that", "we", "know", "of", "-", ",", "and", "that", "a", "considerable", "amount", "of", "Windows", "users", "have", "been", "unprotected", "for", "more", "than", "2", "months", "since", "the", "public", "exploit", "was", "released", ".", "As", "of", "January", "10th", ",", "Microsoft", "decided", "to", "release", "a", "new", "security", "bulletin", "including", "a", "patch", "for", "the", "affected", "systems", "(", "MS17", "-", "004", ")", ".", "If", "we", "diff", "against", "the", "latest", "\"", "lsasrv.dll", "\"", "version", "(", "v", "6.1.7601.23642", ")", ",", "we", "can", "see", "that", "the", "vulnerability", "was", "fixed", "by", "changing", "the", "\"", "NegGetExpectedBufferLength", "\"", "function", ".", "Basically", ",", "the", "same", "64KB", "packet", "size", "check", "used", "by", "Windows", "8.1", "and", "Windows", "10", "was", "now", "added", "to", "the", "rest", "of", "the", "Windows", "versions"], "entities": [{"type": "DiscoverVulnerability", "start": 47, "end": 48, "text": ["affected"], "role": "trigger"}, {"type": "Vulnerability", "start": 45, "end": 47, "text": ["The", "vulnerability"], "role": "Vulnerability"}, {"type": "Version", "start": 48, "end": 51, "text": ["all", "Windows", "versions"], "role": "Vulnerable_System_Version"}, {"type": "Version", "start": 53, "end": 57, "text": ["32", "or", "64", "bits"], "role": "Vulnerable_System_Version"}, {"type": "DiscoverVulnerability", "start": 59, "end": 61, "text": ["was", "reported"], "role": "trigger"}, {"type": "DiscoverVulnerability", "start": 63, "end": 64, "text": ["described"], "role": "trigger"}, {"type": "Person", "start": 68, "end": 70, "text": ["Laurent", "Gaffi\u00e9"], "role": "Discoverer"}, {"type": "PatchVulnerability", "start": 6, "end": 7, "text": ["released"], "role": "trigger"}, {"type": "Time", "start": 1, "end": 5, "text": ["November", "8", ",", "2016"], "role": "Time"}, {"type": "Organization", "start": 5, "end": 6, "text": ["Microsoft"], "role": "Releaser"}, {"type": "Patch", "start": 7, "end": 10, "text": ["a", "security", "update"], "role": "Patch"}, {"type": "System", "start": 11, "end": 14, "text": ["Windows", "Authentication", "Methods"], "role": "Vulnerable_System"}, {"type": "Version", "start": 15, "end": 18, "text": ["MS16", "-", "137"], "role": "Vulnerable_System_Version"}, {"type": "PatchVulnerability", "start": 32, "end": 34, "text": ["was", "applied"], "role": "trigger"}, {"type": "CVE", "start": 27, "end": 29, "text": ["CVE", "-2016-7237"], "role": "CVE"}, {"type": "Patch", "start": 30, "end": 32, "text": ["this", "fix"], "role": "Patch"}, {"type": "PatchVulnerability", "start": 662, "end": 663, "text": ["release"], "role": "trigger"}, {"type": "Patch", "start": 668, "end": 670, "text": ["a", "patch"], "role": "Patch"}, {"type": "Organization", "start": 659, "end": 660, "text": ["Microsoft"], "role": "Releaser"}, {"type": "Time", "start": 656, "end": 658, "text": ["January", "10th"], "role": "Time"}, {"type": "System", "start": 673, "end": 679, "text": ["systems", "(", "MS17", "-", "004", ")"], "role": "Vulnerable_System"}, {"type": "PatchVulnerability", "start": 79, "end": 81, "text": ["was", "published"], "role": "trigger"}, {"type": "Patch", "start": 77, "end": 79, "text": ["the", "fix"], "role": "Patch"}, {"type": "PatchVulnerability", "start": 701, "end": 703, "text": ["was", "fixed"], "role": "trigger"}, {"type": "Vulnerability", "start": 699, "end": 701, "text": ["the", "vulnerability"], "role": "Vulnerability"}, {"type": "Version", "start": 689, "end": 694, "text": ["version", "(", "v", "6.1.7601.23642", ")"], "role": "Patch-Number"}, {"type": "Capabilities", "start": 704, "end": 710, "text": ["changing", "the", "\"", "NegGetExpectedBufferLength", "\"", "function"], "role": "Issues-Addressed"}, {"type": "DiscoverVulnerability", "start": 455, "end": 456, "text": ["confirm"], "role": "trigger"}, {"type": "Capabilities", "start": 469, "end": 473, "text": ["establishing", "several", "SMB", "connections"], "role": "Capabilities"}, {"type": "Vulnerability", "start": 457, "end": 459, "text": ["this", "vulnerability"], "role": "Vulnerability"}, {"type": "System", "start": 463, "end": 465, "text": ["Windows", "7"], "role": "Vulnerable_System"}, {"type": "System", "start": 466, "end": 468, "text": ["2008", "R2"], "role": "Vulnerable_System"}, {"type": "Person", "start": 450, "end": 451, "text": ["I"], "role": "Discoverer"}, {"type": "Capabilities", "start": 474, "end": 485, "text": ["sending", "evil", "sizes", "with", "values", "like", "0x1000000", "(", "16", "MB", ")"], "role": "Capabilities"}], "relations": [{"type": "Causal", "head": 1, "tail": 0}, {"type": "Causal", "head": 6, "tail": 5}, {"type": "Causal", "head": 9, "tail": 7}, {"type": "Causal", "head": 14, "tail": 13}, {"type": "Causal", "head": 18, "tail": 16}, {"type": "Causal", "head": 24, "tail": 23}, {"type": "Effect", "head": 23, "tail": 26}, {"type": "Causal", "head": 28, "tail": 27}, {"type": "Causal", "head": 29, "tail": 27}, {"type": "Causal", "head": 32, "tail": 27}, {"type": "Causal", "head": 33, "tail": 27}], "POS": ["IN", "NNP", "CD", ",", "CD", "NNP", "VBD", "DT", "NN", "NN", "IN", "NNP", "NNP", "NNP", "(", "NNP", ":", "CD", ")", "WDT", "VBD", "CD", "NNP", ":", "NNP", "RB", "IN", "NNP", "NNP", ",", "DT", "NN", "VBD", "VBN", "TO", "VB", "JJ", "NNP", ",", "WDT", "VBD", "DT", "NNP", "NN", ".", "DT", "NN", "VBD", "DT", "NNP", "NNS", ",", "RB", "CD", "CC", "CD", "NNS", ",", "CC", "VBD", "VBN", "CC", "RBR", "VBN", "IN", "JJR", "NN", "IN", "NNP", "NNP", "(", "NN", ")", "DT", "JJ", "NN", "IN", "DT", "NN", "VBD", "VBN", ".", "PRP", "RB", "VBD", "JJ", ":", "IN", ":", "NN", "(", "NNP", ")", "NN", "VBG", "DT", "NN", ".", "WRB", "DT", "NNP", "NN", "NNS", ",", "DT", "NN", "VBZ", "RB", "VBN", "IN", "CD", "NNS", ",", "WDT", "VBZ", "RB", "RB", "JJ", "WRB", "PRP", "VBZ", "DT", "NN", "RB", ".", "IN", "DT", "NN", "VBZ", "RB", "TO", "CD", "NNP", ",", "DT", "MD", "RB", "VB", "DT", "NN", "VBZ", ",", "CD", "IN", "DT", "JJ", "NNS", "TO", "VB", "DT", "NNP", ":", "NN", "NN", "MD", "VB", "VBN", ".", "EX", "VBD", "DT", "NN", "RB", "IN", "DT", "NN", ",", "IN", "VBG", "TO", "DT", "NNP", "VBN", "IN", "NNP", "NNP", ",", "DT", "NN", "VBP", "VBN", "IN", "DT", "NN", "NN", ",", "CC", "RB", "IN", "CD", "NN", "IN", "DT", "NNP", "NN", "VBN", "IN", "DT", "NN", ",", "WDT", "VBZ", "NNP", "WRB", "DT", "JJ", "NN", "VBZ", ".", "TO", "VB", "JJ", ",", "DT", "NN", "IN", "DT", "NNP", "NN", "MD", "RB", "VB", "VBN", "RB", ":", "IN", "DT", "JJ", "NNP", "VBZ", "RB", "VB", "DT", "NN", "IN", "NNP", "CD", "CC", "NNP", "CD", ",", "DT", "NN", "CC", "NNP", "VBD", "DT", "NNP", "NNS", "IN", "JJ", ".", "IN", "PRP", "VBD", "IN", ",", "DT", "NNP", "NNP", "NNP", "NN", "VBZ", "DT", "JJ", "NN", "IN", "DT", "NNP", "NN", ".", "RB", ",", "DT", "NN", "VBZ", "TO", "VB", "DT", "CD", "NN", "(", "NNP", ")", "TO", "VB", "DT", "NN", "IN", "DT", "JJ", "NN", ".", "RB", ",", "IN", "DT", "JJS", "JJ", "NNS", ",", "DT", "JJ", "NN", "VBD", "VBN", "IN", "DT", "NN", "WDT", "VBZ", "DT", "JJ", "NN", "IN", "CD", "(", "CD", ")", ".", "IN", "DT", "JJ", "NN", "VBZ", "JJR", ",", "DT", "NN", "MD", "RB", "VB", "DT", "CD", "NN", ",", "CC", "RB", "DT", "MD", "VB", "DT", "CD", "NN", "(", "NNP", ")", ",", "WDT", "MD", "RB", "VB", "DT", "NN", "NN", "VBG", "IN", "DT", "NN", "RB", "VBG", "VBN", ".", "IN", "DT", "JJ", "NN", ",", "IN", "PRP", "VBP", "DT", "JJ", "NN", "IN", "DT", "NN", "RBR", "CC", "JJ", "IN", "CD", "(", "CD", ")", ",", "DT", "NN", "MD", "RB", "VB", "CC", "RB", ",", "DT", "NN", "MD", "RB", "VB", "VBN", ".", "RB", ",", "WRB", "VBP", "VBZ", "CD", "CC", "NNP", "CD", "NN", ".", "IN", "DT", "NN", "VBZ", "VBN", "WRB", "DT", "NN", "NN", "VBZ", ",", "WDT", "VBZ", "RB", "VB", "IN", "DT", "NN", "VBZ", "TO", "VB", "JJ", ",", "CC", "RB", "IN", "DT", "NNP", "NN", "VBZ", "RB", "VB", "JJ", "JJ", "NN", "TO", "VB", ".", "PRP", "VBD", "VBN", "JJ", "TO", "VB", "IN", "DT", "NN", "MD", "VB", "VBN", "IN", "NNP", "CD", "CC", "CD", "NNP", "IN", "VBG", "JJ", "NNP", "NNS", "CC", "VBG", "JJ", "NNS", "IN", "NNS", "IN", "CD", "(", "CD", "NNP", ")", ".", "DT", "NN", "VBZ", "IN", "IN", "DT", "NN", "IN", "DT", "JJS", "JJ", "NNS", ",", "PRP", "VBZ", "RB", "JJ", "TO", "VB", "DT", "NN", "IN", "NNS", ",", "IN", "IN", "PRP", "VBD", "IN", ",", "DT", "NN", "VBZ", "CD", ".", "RB", ",", "DT", "JJ", "NN", "TO", "VB", "DT", "NN", "MD", "VB", "IN", "VBG", "DT", "NN", "NN", "IN", "DT", "NNP", "NN", ".", "PRP", "MD", "VB", "JJ", "TO", "VB", "RB", "IN", "VBG", "DT", "JJ", "NN", "IN", "DT", "NNP", "NN", "NN", ",", "VBG", "JJ", "NNS", "CC", "VBG", "DT", "NN", "NN", "IN", "DT", "NNP", "NNP", "NNP", "NN", "NNS", ".", "RB", ",", "DT", "NN", "NN", "NN", "MD", "VB", "RB", "VBN", "IN", "JJ", "NNS", ".", "PRP", "VBD", "IN", "DT", "NN", "VBD", "RB", "VBG", "WRB", "PRP", "VBD", "TO", "VB", "WRB", "DT", "NN", "NNP", "VBD", "RB", "VBG", "IN", "NNP", "CD", ".", "PRP", "VBZ", "JJ", "TO", "VB", "IN", "NN", "RB", "VBD", "IN", "NN", "IN", "PRP", "VBP", "IN", ":", ",", "CC", "IN", "DT", "JJ", "NN", "IN", "NNP", "NNS", "VBP", "VBN", "VBN", "IN", "JJR", "IN", "CD", "NNS", "IN", "DT", "JJ", "NN", "VBD", "VBN", ".", "IN", "IN", "NNP", "CD", ",", "NNP", "VBD", "TO", "VB", "DT", "JJ", "NN", "NN", "VBG", "DT", "NN", "IN", "DT", "JJ", "NNS", "(", "NNP", ":", "CD", ")", ".", "IN", "PRP", "VBP", "IN", "DT", "JJS", "NN", "NN", "NNP", "NN", "(", "JJ", "CD", ")", ",", "PRP", "MD", "VB", "IN", "DT", "NN", "VBD", "VBN", "IN", "VBG", "DT", "JJ", "NNP", "NNP", "NN", ".", "NNP", ",", "DT", "JJ", "CD", "NN", "NN", "NN", "VBN", "IN", "NNP", "CD", "CC", "NNP", "CD", "VBD", "RB", "VBN", "TO", "DT", "NN", "IN", "DT", "NNP", "NNS"]}